name: Build & Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via Arkturian Jump Host
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: arkturian.com
          username: alex
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e

            AISERVER="aiserver.oneal.eu"
            AISERVER_USER="gsgbot"
            AISERVER_KEY="~/.ssh/aiserver_deploy"
            DEPLOY_PATH="/var/code/gsg-api"
            SERVICE_NAME="gsg-api"

            echo "üöÄ Deploying to $AISERVER via arkturian..."

            # Create temp dir for the code
            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR

            # Clone the repo
            git clone --depth 1 https://github.com/${{ github.repository }}.git repo
            cd repo

            # Sync to aiserver using scp (tar + ssh)
            echo "üì¶ Syncing files to aiserver..."
            tar czf - --exclude='venv' --exclude='.git' --exclude='.env' --exclude='__pycache__' --exclude='*.pyc' . | \
              ssh -i $AISERVER_KEY -o StrictHostKeyChecking=no $AISERVER_USER@$AISERVER "cd $DEPLOY_PATH && tar xzf - --overwrite"

            echo "‚úÖ Files synced"

            # Install deps and restart service on aiserver
            echo "üîÑ Installing dependencies and restarting service..."
            ssh -i $AISERVER_KEY -o StrictHostKeyChecking=no $AISERVER_USER@$AISERVER << 'ENDSSH'
              set -e
              cd /var/code/gsg-api

              # Activate venv and install deps
              if [ ! -d "venv" ]; then
                python3 -m venv venv
              fi
              source venv/bin/activate
              pip install -q -r requirements.txt

              # Restart service
              sudo systemctl restart gsg-api

              # Health check
              sleep 3
              if curl -sf http://localhost:8000/health > /dev/null; then
                echo "‚úÖ Health check passed!"
              else
                echo "‚ö†Ô∏è Health check failed"
                sudo systemctl status gsg-api --no-pager || true
              fi
            ENDSSH

            # Cleanup
            rm -rf $TEMP_DIR

            echo "üéâ Deployment completed!"

      - name: Notify on success
        if: success()
        run: echo "‚úÖ Deployment successful for commit ${{ github.sha }}"

      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Deployment failed for commit ${{ github.sha }}"
