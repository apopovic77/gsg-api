name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: /var/www/gsg-api
  SERVICE_NAME: gsg-api

jobs:
  deploy:
    name: Deploy to aiserver via arkturian
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via Arkturian Jump Host
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: arkturian.com
          username: alex
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e

            AISERVER="aiserver.oneal.eu"
            AISERVER_USER="gsgbot"
            AISERVER_KEY="~/.ssh/oneal_aiserver"
            DEPLOY_PATH="/var/www/gsg-api"

            echo "üöÄ Deploying to $AISERVER via arkturian..."

            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR

            git clone --depth 1 https://github.com/${{ github.repository }}.git repo
            cd repo

            echo "üì¶ Syncing files to aiserver..."
            tar czf - --exclude='venv' --exclude='.git' --exclude='.env' --exclude='__pycache__' --exclude='*.pyc' . | \
              ssh -i $AISERVER_KEY -o StrictHostKeyChecking=no $AISERVER_USER@$AISERVER "cd $DEPLOY_PATH && tar xzf - --overwrite"

            echo "‚úÖ Files synced"

            echo "üîÑ Installing dependencies and restarting service..."
            ssh -i $AISERVER_KEY -o StrictHostKeyChecking=no $AISERVER_USER@$AISERVER << 'ENDSSH'
              set -e
              cd /var/www/gsg-api
              source venv/bin/activate
              pip install -q -r requirements.txt
              sudo systemctl restart gsg-api
              sleep 3
              if curl -sf http://localhost:8000/health > /dev/null; then
                echo "‚úÖ Health check passed!"
              else
                echo "‚ö†Ô∏è Health check failed"
                exit 1
              fi
            ENDSSH

            rm -rf $TEMP_DIR
            echo "üéâ Deployment completed!"

      - name: Notify on success
        if: success()
        run: echo "‚úÖ Deployment successful"

      - name: Notify on failure
        if: failure()
        run: echo "‚ùå Deployment failed"
